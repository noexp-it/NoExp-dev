@page "/JobAds/Create"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "EmployerRole")]

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using MudExRichTextEditor.Types
@using NoExp.Application.Interfaces
@using NoExp.Application.Services
@using NoExp.Domain.Entities
@using NoExp.Domain.Enums.JobAd
@using NoExp.Infrastructure.Persistence
@using NoExp.Presentation.Components.Account

@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@inject IProfileService ProfileService
@inject IJobAdService JobAdService
@inject MudBlazor.ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudPaper Class="pa-4 mt-4 mx-auto " Elevation="2" MaxWidth="60%">
    <MudForm @ref="_form" Model="Input" @bind-IsValid="_isValid">
       
        <MudTextField @bind-Value="Input.Title" 
                        Label="Job Title" 
                        Variant="Variant.Outlined" 
                        For="@(() => Input.Title)"    
                        MaxLength="50" 
                        Adornment="Adornment.Start" 
                        AdornmentIcon="@Icons.Material.Filled.Title"
                        Validation="@(new Func<string, IEnumerable<string>>(TitleInputValidator))" Required="true"/>
       
        <MudCard class="mb-3">
            <MudCardContent>
                <MudText Typo="Typo.h6">Description</MudText>
                <MudExRichTextEdit @ref="@Editor"
                                   @bind-Value="Input.Description"   
                                   ReadOnly="false"
                                   Tools="CustomTools.ToArray()"
                                   Class="m-2 mh-100"
                                   Placeholder="Description"
                                   EnableResize="true"
                                   Validation="@(new Func<string, IEnumerable<string>>(DescriptionInputValidator))">
                </MudExRichTextEdit>
                <ValidationMessage For="@(() => Input.Description)" />
            </MudCardContent>
        </MudCard>

        <MudCard Class="mb-1">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Tech Stack</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudChipSet T="string" Style="max-height: 15vh; overflow-y: auto">
                    @foreach (var skill in AddedTechStack)
                    {
                        <MudChip Text="@skill"
                                 OnClose="@((MudChip<string> chip) => RemoveItem(AddedTechStack, skill))"
                                 Closeable="true"
                                 Color="Color.Success"
                                 Variant="Variant.Outlined" />
                    }
                </MudChipSet>
            </MudCardContent>
            <MudCardActions>
                <MudTextField @bind-Value="Input.TechStack"
                              Placeholder="Type and press Enter"
                              OnKeyDown="TechStackHandleKeyDown"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Add"
                              AdornmentColor="Color.Primary"
                              Immediate="true"
                              Variant="Variant.Outlined"
                              TextUpdateSuppression=false />
            </MudCardActions>
        </MudCard>
        
        <MudDatePicker Label="Expiration Date" @bind-Date="Input.ExpirationDate" Variant="Variant.Outlined" Adornment="Adornment.Start" />

        <MudGrid>
             <MudItem xs="6">
                <MudSelect T="WorkType" Variant="Variant.Outlined" Label="Work Type" @bind-Value="Input.WorkType" Required="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Checklist">
                    @foreach (var type in Enum.GetValues(typeof(WorkType)).Cast<WorkType>())
                    {
                        <MudSelectItem Value="@type">@type</MudSelectItem>
                    }
                </MudSelect>
             </MudItem>
             <MudItem xs="6">
                <MudSelect T="WorkMode" Variant="Variant.Outlined" Label="Work Mode" @bind-Value="Input.WorkMode" Required="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Checklist">
                    @foreach (var mode in Enum.GetValues(typeof(WorkMode)).Cast<WorkMode>())
                    {
                        <MudSelectItem Value="@mode">@mode</MudSelectItem>
                    }
                </MudSelect>
             </MudItem>
        </MudGrid>

        <MudTextField @bind-Value="Input.Location" Label="Location" Variant="Variant.Outlined" For="@(() => Input.Location)" Required="true" MaxLength="100" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.MyLocation"/>

        <MudGrid Class="mb-4">
            <MudItem xs="6">
                <MudTextField @bind-Value="Input.SalaryMin" Label="Minimum Salary" Variant="Variant.Outlined" For="@(() => Input.SalaryMin)" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
            </MudItem>
            <MudItem xs="6">
                <MudTextField @bind-Value="Input.SalaryMax" Label="Maximum Salary" Variant="Variant.Outlined" For="@(() => Input.SalaryMax)" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
            </MudItem>
        </MudGrid>

        <MudButton OnClick="OnValidSubmitAsync" Variant="Variant.Filled" Color="Color.Primary" Disabled="!_isValid">Submit</MudButton>
    </MudForm>
</MudPaper>

@code {
    private MudForm? _form;
    private JobAdModel Input { get; set; } = new();
    private bool _isValid = false;
    private List<string> AddedRequirements { get; set; } = new();
    private List<string> AddedResponsibilities { get; set; } = new();
    private List<string> AddedTechStack { get; set; } = new();
    MudExRichTextEdit Editor;


    private async Task OnValidSubmitAsync()
    {
        await _form!.Validate();
        if (_isValid)
        {
            try
            {
                var user = (await AuthStateProvider.GetAuthenticationStateAsync()).User;
                var userId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

                EmployerProfile? employerProfile = await ProfileService.GetEmployerProfileByUserIdAsync(userId);

                if (employerProfile == null)
                {
                    Snackbar.Add("Employer profile not found. Please create an employer profile first.", MudBlazor.Severity.Error);
                    return;
                }

                var newJobAd = new JobAd
                {
                    Id = Guid.NewGuid(),
                    Title = Input.Title,
                    Description = Input.Description,
                    WorkType = Input.WorkType,
                    WorkMode = Input.WorkMode,
                    Location = Input.Location,
                    SalaryMin = Input.SalaryMin,
                    SalaryMax = Input.SalaryMax,
                    PublishDate = DateTime.UtcNow,
                    ExpirationDate = Input.ExpirationDate,
                    EmployerProfileId = employerProfile!.Id,
                    EmployerProfile = employerProfile

                };

                await JobAdService.SaveJobAdAsync(newJobAd);
                Snackbar.Add("Your Job Ad has been created successfully.", MudBlazor.Severity.Success);
                NavigationManager.NavigateTo("/");
            } 
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", MudBlazor.Severity.Error);
            }

        }
    }

    private async Task TechStackHandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(Input.TechStack))
        {
            if (!AddedTechStack.Contains(Input.TechStack))
            {
                AddedTechStack.Add(Input.TechStack.Trim());
            }
            else
            {
                Snackbar.Add(new MarkupString($"{Input.TechStack} skill exists!"), MudBlazor.Severity.Error);
            }

            await Task.Delay(10);
            Input.TechStack = string.Empty;
            StateHasChanged();

        }
    }

    private void RemoveItem(List<string> list, string item)
    {
        list.Remove(item);
    }

    private List<MudExRichTextEditor.Types.QuillTool> CustomTools = new List<QuillTool>
{
    new QuillTool(cls: "ql-header", group: 1, options: new string[] { "", "1", "2", "3", "4", "5", "6" }),
    new QuillTool(cls: "ql-bold", group: 2),
    new QuillTool(cls: "ql-italic", group: 2),
    new QuillTool(cls: "ql-underline", group: 2),
    new QuillTool(cls: "ql-list", group: 4, value: "ordered"),
    new QuillTool(cls: "ql-list", group: 4, value: "bullet"),
    new QuillTool(cls: "ql-align", group: 4, options: new string[] { "", "center", "right", "justify" }),
    new QuillTool(cls: "ql-color", group: 3, options: Array.Empty<string>()),
    new QuillTool(cls: "ql-blockquote", group: 5)
};

    private sealed class JobAdModel
    {
        [Required(ErrorMessage = "Job Ad Title is required")]
        [StringLength(100, MinimumLength = 2, ErrorMessage = "Title must be between 3 and 50 characters.")]
        public string Title { get; set; }

        [Required(ErrorMessage = "Job Ad Description is required")]
        [StringLength(1000, MinimumLength = 10, ErrorMessage = "Description must be between 10 and 1000 characters.")]
        public string Description { get; set; }

        public WorkType WorkType { get; set; }

        public WorkMode WorkMode { get; set; }

        [Required(ErrorMessage = "Location is required")]
        [StringLength(50, MinimumLength = 3, ErrorMessage = "Location must be between 3 and 50 characters.")]
        public string Location { get; set; }

        [Required(ErrorMessage = "Minimum Salary is required")]
        public decimal SalaryMin { get; set; }

        [Required(ErrorMessage = "Maximum Salary is required")]
        [GreaterThan("SalaryMin", ErrorMessage = "Maximum Salary must be greater than Minimum Salary.")]
        public decimal SalaryMax { get; set; }

        [Required(ErrorMessage = "Tech Stack is required")]
        public string TechStack { get; set;  }

        [Required(ErrorMessage = "Requirements are required")]
        [StringLength(100, MinimumLength = 10, ErrorMessage = "Requirements must be between 10 and 1000 characters.")]
        public string Requirements { get; set; }

        [Required(ErrorMessage = "Responsibilities are required")]
        [StringLength(100, MinimumLength = 10, ErrorMessage = "Responsibilities must be between 10 and 1000 characters.")]
        public string Responsibilities { get; set; }

        [Required(ErrorMessage = "Offer details are required")]
        [StringLength(1000, MinimumLength = 10, ErrorMessage = "Offer must be between 10 and 1000 characters.")]
        public string Offer { get; set; }

        public DateTime? ExpirationDate { get; set; }
    }

    private IEnumerable<string> TitleInputValidator(string title)
    {
        if (string.IsNullOrWhiteSpace(title))
        {
            yield return "Title is required.";
            yield break;
        }
        
        if (title.Length < 3 || title.Length > 50)
        {
            yield return "Title must be between 3 and 50 characters.";
        }
    }

    private IEnumerable<string> DescriptionInputValidator(string title)
    {
        if (string.IsNullOrWhiteSpace(title))
        {
            yield return "Description is required.";
            yield break;
        }

        if (title.Length < 3 || title.Length > 5000)
        {
            yield return "Title must be between 3 and 5000 characters.";
        }


    }
}