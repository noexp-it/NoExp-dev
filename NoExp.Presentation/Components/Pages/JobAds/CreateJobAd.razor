@page "/JobAds/Create"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "EmployerRole")]

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using MudExRichTextEditor.Types
@using NoExp.Application.Interfaces
@using NoExp.Application.Services
@using NoExp.Domain.Entities
@using NoExp.Domain.Enums.JobAd
@using NoExp.Infrastructure.Persistence
@using NoExp.Presentation.Components.Account
@using System.Text.RegularExpressions
@using FluentValidation
@using System.Threading
@using MudExRichTextEditor

@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@inject IProfileService ProfileService
@inject IJobAdService JobAdService
@inject MudBlazor.ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudPaper Class="pa-4 mt-4 mx-auto " Elevation="2" MaxWidth="60%">
    <MudForm @ref="form" Model="Input" Validation="@(validator.ValidateValue)" ValidationDelay="0">
        <MudTextField @bind-Value="Input.Title"
                        For="@(() => Input.Title)"
                        Label="Job Title" 
                        Variant="Variant.Outlined" 
                        MaxLength="50" 
                        Adornment="Adornment.Start" 
                        AdornmentIcon="@Icons.Material.Filled.Title"/>
       
        <MudCard class="mb-3">
            <MudCardContent>
                <MudText Typo="Typo.h6">Description</MudText>
                <MudExRichTextEdit @bind-Value="Input.Description"
                                   ReadOnly="false"
                                   Tools="@CustomTools.ToArray()"
                                   Class="m-2 mh-100"
                                   Placeholder="Description"
                                   EnableResize="true"
                                   Required="true">
                </MudExRichTextEdit>
            </MudCardContent>
        </MudCard>

        <MudCard Class="mb-1">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Tech Stack</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudChipSet T="string" Style="max-height: 15vh; overflow-y: auto">
                    @foreach (var skill in AddedTechStack)
                    {
                        <MudChip Text="@skill"
                                 OnClose="@((MudChip<string> chip) => RemoveItem(AddedTechStack, skill))"
                                 Closeable="true"
                                 Color="Color.Success"
                                 Variant="Variant.Outlined" />
                    }
                </MudChipSet>
            </MudCardContent>
            <MudCardActions>
                <MudTextField @bind-Value="Input.TechStack"
                              For="@(() => Input.TechStack)"
                              Placeholder="Type and press Enter"
                              OnKeyDown="TechStackHandleKeyDown"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Add"
                              AdornmentColor="Color.Primary"
                              Immediate="true"
                              Variant="Variant.Outlined"
                              TextUpdateSuppression=false/>
            </MudCardActions>
        </MudCard>
        
        <MudDatePicker Label="Expiration Date" @bind-Date="Input.ExpirationDate"
                       For="@(() => Input.ExpirationDate)"      
                       Variant="Variant.Outlined" Adornment="Adornment.Start" />

        <MudGrid>
             <MudItem xs="6">
                <MudSelect T="WorkType" Label="Work Type" @bind-Value="Input.WorkType"
                           For="@(() => Input.WorkType)"
                           Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Checklist">
                    @foreach (var type in Enum.GetValues(typeof(WorkType)).Cast<WorkType>())
                    {
                        <MudSelectItem Value="@type">@type</MudSelectItem>
                    }
                </MudSelect>
             </MudItem>
             <MudItem xs="6">
                <MudSelect T="WorkMode" Label="Work Mode" @bind-Value="Input.WorkMode"
                           For="@(() => Input.WorkMode)"
                           Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Checklist">
                    @foreach (var mode in Enum.GetValues(typeof(WorkMode)).Cast<WorkMode>())
                    {
                        <MudSelectItem Value="@mode">@mode</MudSelectItem>
                    }
                </MudSelect>
             </MudItem>
        </MudGrid>

        <MudTextField Label="Location" @bind-Value="Input.Location" 
                      For="@(() => Input.Location)" 
                      Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.MyLocation" />

        <MudGrid Class="mb-4">
            <MudItem xs="6">
                <MudTextField Label="Minimum Salary" @bind-Value="Input.SalaryMin"
                              For="@(() => Input.SalaryMin)"
                              Variant="Variant.Outlined"  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
            </MudItem>
            <MudItem xs="6">
                <MudTextField Label="Maximum Salary" @bind-Value="Input.SalaryMax"
                              For="@(() => Input.SalaryMax)"
                              Variant="Variant.Outlined"  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
            </MudItem>
        </MudGrid>

        <MudButton OnClick="OnValidSubmitAsync" Variant="Variant.Filled" Color="Color.Primary">Submit</MudButton>
    </MudForm>
</MudPaper>

@code {
    private MudForm? form;
    private JobAdModel Input { get; set; } = new();
    JobAdModelValidator validator = new JobAdModelValidator();
    private List<string> AddedTechStack { get; set; } = new();
    

    private async Task OnValidSubmitAsync()
    {
        await form!.Validate();
        var result = await validator.ValidateAsync(Input);

        if (result.IsValid)
        {
            try
            {
                var user = (await AuthStateProvider.GetAuthenticationStateAsync()).User;
                var userId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

                EmployerProfile? employerProfile = await ProfileService.GetEmployerProfileByUserIdAsync(userId);

                if (employerProfile == null)
                {
                    Snackbar.Add("Employer profile not found. Please create an employer profile first.", MudBlazor.Severity.Error);
                    return;
                }

                var newJobAd = new JobAd
                {
                    Id = Guid.NewGuid(),
                    Title = Input.Title,
                    Description = Input.Description,
                    WorkType = Input.WorkType,
                    WorkMode = Input.WorkMode,
                    Location = Input.Location,
                    SalaryMin = Input.SalaryMin,
                    SalaryMax = Input.SalaryMax,
                    PublishDate = DateTime.UtcNow,
                    ExpirationDate = Input.ExpirationDate,
                    EmployerProfileId = employerProfile!.Id,
                    EmployerProfile = employerProfile
                };

                await JobAdService.SaveJobAdAsync(newJobAd);
                Snackbar.Add("Your Job Ad has been created successfully.", MudBlazor.Severity.Success);
                NavigationManager.NavigateTo("/");
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", MudBlazor.Severity.Error);
            }
        }
    }

    private async Task TechStackHandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(Input.TechStack))
        {
            if (!AddedTechStack.Contains(Input.TechStack))
            {
                AddedTechStack.Add(Input.TechStack.Trim());
            }
            else
            {
                Snackbar.Add(new MarkupString($"{Input.TechStack} skill exists!"), MudBlazor.Severity.Error);
            }

            await Task.Delay(10);
            Input.TechStack = string.Empty;
            StateHasChanged();

        }
    }

    private void RemoveItem(List<string> list, string item)
    {
        list.Remove(item);
    }

    private List<MudExRichTextEditor.Types.QuillTool> CustomTools = new List<QuillTool>
{
    new QuillTool(cls: "ql-header", group: 1, options: new string[] { "", "1", "2", "3", "4", "5", "6" }),
    new QuillTool(cls: "ql-bold", group: 2),
    new QuillTool(cls: "ql-italic", group: 2),
    new QuillTool(cls: "ql-underline", group: 2),
    new QuillTool(cls: "ql-list", group: 4, value: "ordered"),
    new QuillTool(cls: "ql-list", group: 4, value: "bullet"),
    new QuillTool(cls: "ql-align", group: 4, options: new string[] { "", "center", "right", "justify" }),
    new QuillTool(cls: "ql-color", group: 3, options: Array.Empty<string>()),
    new QuillTool(cls: "ql-blockquote", group: 5)
};

    private sealed class JobAdModel
    {

        public string Title { get; set; }

        public string Description { get; set; }

        public WorkType WorkType { get; set; }

        public WorkMode WorkMode { get; set; }

        public string Location { get; set; }

        public decimal SalaryMin { get; set; }

        public decimal SalaryMax { get; set; }

        public string TechStack { get; set;  }

        public string Requirements { get; set; }

        public string Responsibilities { get; set; }

        public string Offer { get; set; }

        public DateTime? ExpirationDate { get; set; }
    }

    private class JobAdModelValidator : AbstractValidator<JobAdModel>
    {
        public JobAdModelValidator()
        {
            RuleFor(model => model.Title)
                .NotNull()
                .MinimumLength(5)
                .MaximumLength(100);

            RuleFor(model => model.WorkType)
                .NotNull()
                .IsInEnum();

            RuleFor(model => model.WorkMode)
                .NotNull()
                .IsInEnum();

            RuleFor(model => model.TechStack)   
                .MaximumLength(200);

            RuleFor(model => model.ExpirationDate)
                .Must(date => date.HasValue)
                .WithMessage("Expiration date is required")
                .Must(date => !date.HasValue || date.Value > DateTime.UtcNow)
                .WithMessage("Expiration date must be in the future");

            RuleFor(model => model.Location)
                .NotNull()
                .MinimumLength(3)
                .MaximumLength(100);

            RuleFor(model => model.SalaryMin)
                .NotNull()
                .GreaterThanOrEqualTo(0)
                .WithMessage("Minimum salary cannot be negative")
                .LessThan(1000000)
                .WithMessage("Minimum salary is too high");

            RuleFor(model => model.SalaryMax)
                .NotNull()
                .GreaterThanOrEqualTo(model => model.SalaryMin)
                .WithMessage("Maximum salary must be greater than or equal to minimum salary")
                .LessThan(1000000)
                .WithMessage("Maximum salary is too high")
                .When(model => model.SalaryMin > 0);
            
        }

        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
        {
            var result = await ValidateAsync(ValidationContext<JobAdModel>.CreateWithOptions((JobAdModel)model, x => x.IncludeProperties(propertyName)));
            if (result.IsValid)
                return Array.Empty<string>();
            return result.Errors.Select(e => e.ErrorMessage);
        };
    }
}