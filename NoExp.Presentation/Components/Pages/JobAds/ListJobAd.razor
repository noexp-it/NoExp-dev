@using NoExp.Application.Interfaces
@using NoExp.Domain.Entities
@using NoExp.Domain.Enums.JobAd
@inject IJobAdService JobAdService
@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<div class="job-listing-layout">
    <!-- Left Sidebar with Filters -->
    <aside class="filters-sidebar">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-2"/>
                Filters
            </MudText>

            <!-- Search Bar -->
            <MudTextField @bind-Value="searchText"
                          Label="Search jobs"
                          Placeholder="Search..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined"
                          Immediate="true"
                          OnDebounceIntervalElapsed="ApplyFilters"
                          DebounceInterval="300"
                          Class="mb-4"/>

            <!-- Location Filter -->
            <MudTextField @bind-Value="locationFilter"
                          Label="Location"
                          Placeholder="Any location..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.LocationOn"
                          Variant="Variant.Outlined"
                          Immediate="true"
                          OnDebounceIntervalElapsed="ApplyFilters"
                          DebounceInterval="300"
                          Class="mb-4"/>

            <!-- Work Type Multi-Select Filter -->
            <MudSelect T="WorkType" 
                       SelectedValues="@workTypeFilters"
                       SelectedValuesChanged="@OnWorkTypeFiltersChanged"
                       Label="Work Type"
                       Variant="Variant.Outlined"
                       MultiSelection="true"
                       SelectAll="true"
                       SelectAllText="Select All Types"
                       AdornmentIcon="@Icons.Material.Filled.Work"
                       Adornment="Adornment.Start"
                       AnchorOrigin="Origin.BottomCenter"
                       ToStringFunc="@(type => type.ToString())"
                       Class="mb-4">
                @foreach (var type in Enum.GetValues(typeof(WorkType)).Cast<WorkType>())
                {
                    <MudSelectItem T="WorkType" Value="@type">@type</MudSelectItem>
                }
            </MudSelect>

            <!-- Work Mode Multi-Select Filter -->
            <MudSelect T="WorkMode" 
                       SelectedValues="@workModeFilters"
                       SelectedValuesChanged="@OnWorkModeFiltersChanged"
                       Label="Work Mode"
                       Variant="Variant.Outlined"
                       MultiSelection="true"
                       SelectAll="true"
                       SelectAllText="Select All Modes"
                       AdornmentIcon="@Icons.Material.Filled.HomeWork"
                       Adornment="Adornment.Start"
                       AnchorOrigin="Origin.BottomCenter"
                       ToStringFunc="@(mode => mode.ToString())"
                       Class="mb-4">
                @foreach (var mode in Enum.GetValues(typeof(WorkMode)).Cast<WorkMode>())
                {
                    <MudSelectItem T="WorkMode" Value="@mode">@mode</MudSelectItem>
                }
            </MudSelect>

            <!-- Salary Range Filter -->
            <MudText Typo="Typo.subtitle2" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small" Class="mr-1"/>
                Salary Range
            </MudText>
            <MudNumericField T="decimal?" Value="@minSalary"
                             ValueChanged="@OnMinSalaryChanged"
                             Label="Min Salary"
                             Variant="Variant.Outlined"
                             Min="0"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                             Class="mb-3"/>

            <MudNumericField T="decimal?" Value="@maxSalary"
                             ValueChanged="@OnMaxSalaryChanged"
                             Label="Max Salary"
                             Variant="Variant.Outlined"
                             Min="0"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                             Class="mb-4"/>

            <MudDivider Class="mb-4"/>

            <!-- Items per page selector -->
            <MudText Typo="Typo.subtitle2" Class="mb-2">Items per page</MudText>
            <MudSelect T="int" @bind-Value="itemsPerPage" Variant="Variant.Outlined" Dense="true" FullWidth="true" Class="mb-4">
                <MudSelectItem Value="5">5</MudSelectItem>
                <MudSelectItem Value="10">10</MudSelectItem>
                <MudSelectItem Value="15">15</MudSelectItem>
                <MudSelectItem Value="20">20</MudSelectItem>
                <MudSelectItem Value="50">50</MudSelectItem>
            </MudSelect>

            <!-- Action Buttons -->
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.Clear"
                       OnClick="ClearFilters"
                       FullWidth="true">
                Clear All
            </MudButton>
        </MudPaper>
    </aside>

    <!-- Right Content Area with Job Listings -->
    <main class="job-listings-content">
        <!-- Top Bar with Results Info -->
        <MudPaper Class="pa-3 mb-4 d-flex justify-content-between align-items-center flex-wrap" Elevation="1">
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                <strong>@filteredJobAds.Count</strong> jobs found
            </MudText>
        </MudPaper>

        <!-- Job Ads List -->
        @if (isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4"/>
        }
        else if (!filteredJobAds.Any())
        {
            <MudPaper Class="pa-8 text-center" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary"/>
                <MudText Typo="Typo.h6" Class="mt-4">No job ads found</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Try adjusting your filters or search criteria</MudText>
            </MudPaper>
        }
        else
        {
            <!-- Paginated Results Info -->
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                Showing @GetStartIndex() - @GetEndIndex() of @filteredJobAds.Count results
            </MudText>

            @foreach (var jobAd in pagedJobAds)
            {
                <MudCard Class="@GetJobCardClass(jobAd)" Elevation="2" Style="cursor: pointer; transition: all 0.3s; position: relative;" @onclick="@(() => NavigateToJobDetails(jobAd.Id))">
                    @* Special Badge for Practice/Internship *@
                    @if (jobAd.WorkType == WorkType.Practice || jobAd.WorkType == WorkType.Internship)
                    {
                        <div class="entry-level-badge">
                            <MudIcon Icon="@Icons.Material.Filled.Spa" Size="Size.Small" Class="me-1"/>
                            @jobAd.WorkType
                        </div>
                    }

                    @* Favorite Button *@
                    <div class="favorite-button" @onclick:stopPropagation="true">
                        <MudIconButton Icon="@(IsFavorite(jobAd.Id) ? Icons.Material.Filled.Favorite : Icons.Material.Filled.FavoriteBorder)"
                                       Color="@(IsFavorite(jobAd.Id) ? Color.Error : Color.Default)"
                                       Size="Size.Small"
                                       OnClick="@(() => ToggleFavorite(jobAd.Id))"/>
                    </div>

                    <MudCardContent Class="py-3">
                        <MudGrid>
                            <MudItem xs="12" sm="2" Class="d-flex align-items-center justify-content-center">
                                <MudAvatar Size="Size.Medium" Color="@GetAvatarColor(jobAd)">
                                    <MudIcon Icon="@GetAvatarIcon(jobAd)" Size="Size.Medium"/>
                                </MudAvatar>
                            </MudItem>
                            <MudItem xs="12" sm="10">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.subtitle1" Class="fw-bold">@jobAd.Title</MudText>

                                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="flex-wrap">
                                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.LocationOn">
                                            @jobAd.Location
                                        </MudChip>
                                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Work" Color="@GetWorkTypeChipColor(jobAd)">
                                            @jobAd.WorkType
                                        </MudChip>
                                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.HomeWork" Color="Color.Success">
                                            @jobAd.WorkMode
                                        </MudChip>
                                        @if (jobAd.SalaryMin.HasValue && jobAd.SalaryMax.HasValue)
                                        {
                                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Warning">
                                                @($"{jobAd.SalaryMin:N0} - {jobAd.SalaryMax:N0}")
                                            </MudChip>
                                        }
                                    </MudStack>

                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-truncate-2">
                                        @((MarkupString)TruncateHtml(jobAd.Description, DescriptionTruncateLength))
                                    </MudText>

                                    @if (jobAd.TechStack.Any())
                                    {
                                        <MudStack Row="true" Spacing="1" Class="flex-wrap mt-1">
                                            @foreach (var skill in jobAd.TechStack.Take(MaxVisibleTechStackSkills))
                                            {
                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">
                                                    @skill
                                                </MudChip>
                                            }
                                            @if (jobAd.TechStack.Count > MaxVisibleTechStackSkills)
                                            {
                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Text">
                                                    +@(jobAd.TechStack.Count - MaxVisibleTechStackSkills) more
                                                </MudChip>
                                            }
                                        </MudStack>
                                    }
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                </MudCard>
            }

            <!-- Pagination Controls -->
            <MudPaper Class="d-flex justify-content-center align-items-center pa-4 mt-4" Elevation="0">
                <MudPagination
                    Count="@totalPages"
                    Selected="@currentPage"
                    SelectedChanged="OnPageChanged"
                    ShowFirstButton="true"
                    ShowLastButton="true"
                    ShowPreviousButton="true"
                    ShowNextButton="true"
                    BoundaryCount="1"
                    MiddleCount="3"
                    Color="Color.Primary"
                    Size="Size.Large"/>
            </MudPaper>
        }
    </main>
</div>

<style>
    .job-listing-layout {
        display: flex;
        gap: 1.5rem;
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .filters-sidebar {
        flex: 0 0 300px;
        position: sticky;
        top: 80px;
        height: fit-content;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        /* Firefox scrollbar styling */
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
    }

    .job-listings-content {
        flex: 1;
        min-width: 0;
    }

    /* Mobile responsive */
    @@media (max-width: 960px) {
        .job-listing-layout {
            flex-direction: column;
        }

        .filters-sidebar {
            position: relative;
            top: 0;
            flex: 1 1 auto;
            max-height: none;
        }
    }

    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Entry-Level Job Card Background */
    .practice-card,
    .internship-card {
        background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%) !important;
        border-left: 4px solid #4CAF50 !important;
    }

    /* Entry-Level Badge Style */
    .entry-level-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 4px 10px;
        border-radius: 16px;
        font-weight: 500;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        z-index: 2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        color: white;
    }

    /* Favorite Button Styles */
    .favorite-button {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 2;
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }

    .favorite-button:hover {
        opacity: 1;
    }

    .favorite-button button {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        padding: 4px;
    }

    .favorite-button button:hover {
        background-color: rgba(255, 255, 255, 1);
        transform: scale(1.1);
    }

    /* Hover effect for entry-level cards */
    .practice-card:hover,
    .internship-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
    }

    /* Show favorite button more prominently on card hover */
    .mud-card:hover .favorite-button {
        opacity: 1;
    }

    /* Webkit browsers (Chrome, Safari, Edge) scrollbar styling */
    .filters-sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .filters-sidebar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .filters-sidebar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .filters-sidebar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

@code {
    private List<JobAd> jobAds = new();
    private List<JobAd> filteredJobAds = new();
    private List<JobAd> pagedJobAds = new();
    private bool isLoading = true;

    // Constants for magic numbers
    private const int MaxVisibleTechStackSkills = 4;
    private const int DescriptionTruncateLength = 150;

    // Filter parameters
    private string searchText = string.Empty;
    private string locationFilter = string.Empty;
    private IEnumerable<WorkType> workTypeFilters = new HashSet<WorkType>();
    private IEnumerable<WorkMode> workModeFilters = new HashSet<WorkMode>();
    private decimal? minSalary;
    private decimal? maxSalary;

    // Pagination parameters
    private int currentPage = 1;
    private int itemsPerPage = 10;
    private int totalPages => (int)Math.Ceiling((double)filteredJobAds.Count / itemsPerPage);

    // Favorites tracking
    private HashSet<Guid> favoriteJobIds = new();

    private DateTime _lastFilterApplied = DateTime.MinValue;
    private bool _pendingFilterUpdate = false;
    private const int ThrottleMs = 200;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobAdsAsync();
    }

    private async Task LoadJobAdsAsync()
    {
        isLoading = true;
        jobAds = await JobAdService.GetAllJobAdsAsync();
        ApplyFilters();
        isLoading = false;
    }

    private void OnMinSalaryChanged(decimal? value)
    {
        minSalary = value;
        ApplyFilters();
    }

    private void OnMaxSalaryChanged(decimal? value)
    {
        maxSalary = value;
        ApplyFilters();
    }

    private async Task OnWorkTypeFiltersChanged(IEnumerable<WorkType> values)
    {
        workTypeFilters = values;
        await ApplyFiltersThrottled();
    }

    private async Task OnWorkModeFiltersChanged(IEnumerable<WorkMode> values)
    {
        workModeFilters = values;
        await ApplyFiltersThrottled();
    }

    private async Task ApplyFiltersThrottled()
    {
        var timeSinceLastApply = (DateTime.Now - _lastFilterApplied).TotalMilliseconds;
        
        if (timeSinceLastApply >= ThrottleMs)
        {
            ApplyFilters();
            _lastFilterApplied = DateTime.Now;
        }
        else if (!_pendingFilterUpdate)
        {
            _pendingFilterUpdate = true;
            await Task.Delay(ThrottleMs - (int)timeSinceLastApply);
            ApplyFilters();
            _lastFilterApplied = DateTime.Now;
            _pendingFilterUpdate = false;
        }
    }

    private void ApplyFilters()
    {
        filteredJobAds = jobAds.Where(job =>
        {
            // Search filter (title, description, tech stack)
            if (!string.IsNullOrWhiteSpace(searchText))
            {
                var search = searchText.ToLower();
                var matchesTitle = job.Title.ToLower().Contains(search);
                var matchesDescription = job.Description.ToLower().Contains(search);
                var matchesTechStack = job.TechStack.Any(tech => tech.ToLower().Contains(search));

                if (!matchesTitle && !matchesDescription && !matchesTechStack)
                    return false;
            }

            // Location filter
            if (!string.IsNullOrWhiteSpace(locationFilter) &&
                !job.Location.Contains(locationFilter, StringComparison.OrdinalIgnoreCase))
                return false;

            // Work Type multi-select filter
            if (workTypeFilters.Any() && !workTypeFilters.Contains(job.WorkType))
                return false;

            // Work Mode multi-select filter
            if (workModeFilters.Any() && !workModeFilters.Contains(job.WorkMode))
                return false;

            // Salary range filter - check if ranges overlap
            if (minSalary.HasValue || maxSalary.HasValue)
            {
                // Skip jobs without salary information when filtering by salary
                if (!job.SalaryMin.HasValue || !job.SalaryMax.HasValue)
                    return false;

                // Check if the job's salary range overlaps with the filter range
                if (minSalary.HasValue && job.SalaryMax.Value < minSalary.Value)
                    return false;

                if (maxSalary.HasValue && job.SalaryMin.Value > maxSalary.Value)
                    return false;
            }

            return true;
        }).ToList();

        // Reset to first page when filters change
        currentPage = 1;
        UpdatePagedJobAds();
    }

    private void ClearFilters()
    {
        searchText = string.Empty;
        locationFilter = string.Empty;
        workTypeFilters = new HashSet<WorkType>();
        workModeFilters = new HashSet<WorkMode>();
        minSalary = null;
        maxSalary = null;
        currentPage = 1;

        ApplyFilters();
    }

    private void OnPageChanged(int page)
    {
        currentPage = page;
        UpdatePagedJobAds();
    }

    private void UpdatePagedJobAds()
    {
        var skip = (currentPage - 1) * itemsPerPage;
        pagedJobAds = filteredJobAds
            .Skip(skip)
            .Take(itemsPerPage)
            .ToList();
    }

    private int GetStartIndex()
    {
        if (!filteredJobAds.Any()) return 0;
        return ((currentPage - 1) * itemsPerPage) + 1;
    }

    private int GetEndIndex()
    {
        if (!filteredJobAds.Any()) return 0;
        var end = currentPage * itemsPerPage;
        return Math.Min(end, filteredJobAds.Count);
    }

    private string TruncateHtml(string? html, int maxLength)
    {
        if (string.IsNullOrEmpty(html))
            return string.Empty;

        // Remove HTML tags for truncation
        var plainText = System.Text.RegularExpressions.Regex.Replace(html, "<.*?>", string.Empty);

        if (plainText.Length <= maxLength)
            return html;

        return plainText.Substring(0, maxLength) + "...";
    }

    // Get CSS class based on job type
    private string GetJobCardClass(JobAd jobAd)
    {
        return jobAd.WorkType switch
        {
            WorkType.Practice => "mb-3 practice-card",
            WorkType.Internship => "mb-3 internship-card",
            _ => "mb-3"
        };
    }

    // Get avatar color based on job type
    private Color GetAvatarColor(JobAd jobAd)
    {
        return jobAd.WorkType switch
        {
            WorkType.Practice => Color.Success,
            WorkType.Internship => Color.Success,
            _ => Color.Primary
        };
    }

    // Get avatar icon based on job type
    private string GetAvatarIcon(JobAd jobAd)
    {
        return jobAd.WorkType switch
        {
            WorkType.Practice => Icons.Material.Filled.Park,
            WorkType.Internship => Icons.Material.Filled.Park,
            _ => Icons.Material.Filled.Business
        };
    }

    // Get chip color for work type
    private Color GetWorkTypeChipColor(JobAd jobAd)
    {
        return jobAd.WorkType switch
        {
            WorkType.Practice => Color.Success,
            WorkType.Internship => Color.Success,
            _ => Color.Default
        };
    }

    // Check if a job is favorited
    private bool IsFavorite(Guid jobAdId)
    {
        return favoriteJobIds.Contains(jobAdId);
    }

    // Handle favorite toggle
    private void ToggleFavorite(Guid jobAdId)
    {
        if (favoriteJobIds.Contains(jobAdId))
        {
            favoriteJobIds.Remove(jobAdId);
        }
        else
        {
            favoriteJobIds.Add(jobAdId);
        }
        
        // TODO: Implement favorite functionality with backend service
        // This will save/remove the job from user's favorites
        StateHasChanged();
    }

    // Navigate to job details
    private void NavigateToJobDetails(Guid jobAdId)
    {
        NavigationManager.NavigateTo($"/JobAds/Details/{jobAdId}");
    }
}