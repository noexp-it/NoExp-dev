@page "/JobAds/Own"
@using Microsoft.AspNetCore.Authorization
@using NoExp.Application.Interfaces
@using NoExp.Domain.Entities
@rendermode InteractiveServer
@attribute [Authorize(Roles = "EmployerRole")]

@inject AuthenticationStateProvider AuthStateProvider
@inject IJobAdService JobAdService
@inject ISnackbar Snackbar
@inject IProfileService ProfileService

@foreach (var jobAd in jobAds)
{
    <MudCard Class="m-3 employer-job-ad-card">
        <MudCardHeader Class="job-ad-header">
            <CardHeaderContent>
                <MudText Class="fs-5 fw-bold">@jobAd.Title</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                         Color="Color.Default" 
                         Dense="true"
                         AnchorOrigin="Origin.TopRight"
                         TransformOrigin="Origin.TopRight">
                    <MudMenuItem Icon="@Icons.Material.Filled.Visibility" 
                                 IconColor="Color.Default"
                                 Href="@($"/JobAds/Details/{jobAd.Id}")">
                        View Details
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Edit" 
                                 IconColor="Color.Primary"
                                 OnClick="@(() => HandleEdit(jobAd.Id))">
                        Edit
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Delete" 
                                 IconColor="Color.Error"
                                 OnClick="@(() => HandleRemove(jobAd.Id))">
                        Remove
                    </MudMenuItem>
                </MudMenu>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" sm="1">
                    <MudImage Src="images/mony.jpg" Alt="Mony the dog" Elevation="25" Class="rounded-lg"/>
                </MudItem>
                <MudItem xs="12" sm="11">
                    <MudText Align="Align.Center">@((MarkupString)jobAd.Description)</MudText>
                    <MudItem Class="d-flex justify-content-center">
                        @foreach (var skill in jobAd.TechStack)
                        {
                            <MudChip T="string" Label="true" Color="Color.Info">@skill</MudChip>
                        }
                    </MudItem>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>
}

@code {
    private List<JobAd> jobAds = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var user = (await AuthStateProvider.GetAuthenticationStateAsync()).User;
            var userId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

            var employerProfile = await ProfileService.GetEmployerProfileByUserIdAsync(userId);

            if (employerProfile == null)
            {
                Snackbar.Add("Employer profile not found. Please create an employer profile first.", Severity.Error);
                return;
            }

            jobAds = await JobAdService.GetAllEmployerJobAdsAsync(employerProfile.Id);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void HandleEdit(Guid jobAdId)
    {
        // TODO: Implement edit logic
    }

    private void HandleRemove(Guid jobAdId)
    {
        // TODO: Implement remove logic
    }
}