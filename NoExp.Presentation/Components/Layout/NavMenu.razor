@implements IDisposable
@rendermode InteractiveServer

@inject NavigationManager NavigationManager

<div class="floating-user-menu">
    <AuthorizeView>
        <Authorized Context="authContext">
            <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Class="user-avatar-menu">
                <ActivatorContent>
                    <MudAvatar Color="Color.Primary" Size="Size.Large" Class="avatar-button">
                        @GetUserInitials(authContext.User.Identity?.Name)
                    </MudAvatar>
                </ActivatorContent>
                <ChildContent>
                    <div class="user-menu-header">
                        <MudText Typo="Typo.subtitle1" Class="font-weight-bold">@authContext.User.Identity?.Name</MudText>
                    </div>
                    <MudDivider />
                    <MudMenuItem Href="/" Icon="@Icons.Material.Filled.Home">Home</MudMenuItem>
                    <AuthorizeView Roles="EmployerRole" Context="employerContext">
                        <MudDivider />
                        <MudMenuItem Href="/JobAds/Own" Icon="@Icons.Material.Filled.ViewList">Your Job Ads</MudMenuItem>
                        <MudMenuItem Href="/JobAds/Create" Icon="@Icons.Material.Filled.AddCircle">Add Job Ad</MudMenuItem>
                    </AuthorizeView>
                    <MudDivider />
                    <MudMenuItem Href="Account/Manage" Icon="@Icons.Material.Filled.Person">Profile</MudMenuItem>
                    <MudMenuItem>
                        <form action="Account/Logout" method="post" style="margin:0; padding:0; width:100%;">
                            <AntiforgeryToken/>
                            <input type="hidden" name="ReturnUrl" value="@currentUrl"/>
                            <MudButton ButtonType="ButtonType.Submit" Color="Color.Error" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Logout" Style="justify-content: flex-start; text-transform: none;">
                                Logout
                            </MudButton>
                        </form>
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
        </Authorized>
        <NotAuthorized>
            <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Class="user-avatar-menu">
                <ActivatorContent>
                    <MudAvatar Color="Color.Default" Size="Size.Large" Class="avatar-button">
                        <MudIcon Icon="@Icons.Material.Filled.Person" />
                    </MudAvatar>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Href="/" Icon="@Icons.Material.Filled.Home">Home</MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Href="Account/Register" Icon="@Icons.Material.Filled.PersonAdd">Register</MudMenuItem>
                    <MudMenuItem Href="Account/Login" Icon="@Icons.Material.Filled.Login">Login</MudMenuItem>
                </ChildContent>
            </MudMenu>
        </NotAuthorized>
    </AuthorizeView>
</div>

<div class="floating-logo">
    <MudLink Href="/" Underline="Underline.None">
        <MudImage Src="images/logo.png" Alt="NoExp.IT Logo Home" Height="80" ObjectFit="ObjectFit.Contain"/>
    </MudLink>
</div>

@code {
    private string? currentUrl;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private string GetUserInitials(string? userName)
    {
        if (string.IsNullOrWhiteSpace(userName))
            return "U";
        
        var parts = userName.Split(' ', '@');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return userName[0].ToString().ToUpper();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}

